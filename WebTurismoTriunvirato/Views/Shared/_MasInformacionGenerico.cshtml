@model Web_Turismo_Triunvirato.Models.ViewModels.ModalContratoViewModel
@using System.Globalization;
@using System.Text.RegularExpressions; 

@{
    var modalTargetId = $"packageModal-{Model.IdItem}";
    var modalMailId = $"mailModal-{Model.IdItem}";


    var cleanTitle = Regex.Replace(Model.Title ?? "", @"\s*\(.*?\)\s*", "").Trim();
    var encodedMessage = Uri.EscapeDataString(Model.RenderedWhatsappMessage);
    var whatsappLink = $"https://wa.me/{Model.WhatsappNumber}?text={encodedMessage}";
    var descriptionContent = string.IsNullOrEmpty(Model.LongDescription) ? "Detalles del paquete no disponibles." : Model.LongDescription;
}

<div class="modal fade" id="@modalTargetId" tabindex="-1" aria-labelledby="@($"title-{modalTargetId}")" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="@($"title-{modalTargetId}")">@cleanTitle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-3 mb-md-0">
                        <!-- IMAGEN PRINCIPAL: Se añadió la clase img-principal-modal para el script -->
                        <div class="main-image-wrapper mb-3">
                            <img src="@Model.ImageUrl" 
                                 class="img-fluid rounded shadow-sm img-principal-modal" 
                                 alt="@Model.Title" 
                                 style="transition: opacity 0.2s ease-in-out; width: 100%; height: auto;"/>
                        </div>

                        <!-- GALERÍA DE MINIATURAS (COLLECTION) -->
                        @if (Model.GaleriaImagenes != null && Model.GaleriaImagenes.Count > 0)
                        {
                            <div class="d-flex flex-wrap gap-2 justify-content-start mt-2">
                                @foreach (var imgPath in Model.GaleriaImagenes)
                                {
                                    <img src="@Url.Content(imgPath)" 
                                         class="img-thumbnail" 
                                         style="width: 70px; height: 50px; cursor: pointer; object-fit: cover;" 
                                         onclick="cambiarImagenModal('@Model.IdItem', '@Url.Content(imgPath)')" 
                                         alt="Miniatura" />
                                }
                            </div>
                        }
                    </div>

                    <div class="col-md-6">
                        <p class="text-muted small">@Model.DetailText</p>
                        <div class="package-description-container">
                            <p>@Html.Raw(descriptionContent)</p>
                        </div>
                        <p class="h4 fw-bold text-success mt-3">
                            @Model.Price.ToString("C", new CultureInfo("es-AR"))
                        </p>
                    </div>
                </div>
            </div>

            <div class="modal-footer d-flex justify-content-between">
                <a href="@whatsappLink" target="_blank" class="btn btn-success flex-fill me-2">
                    <i class="fab fa-whatsapp"></i> Consultar
                </a>

                <button type="button"
                        class="btn btn-outline-primary flex-fill"
                        data-bs-toggle="modal"
                        data-bs-target="#@modalMailId">
                    <i class="fas fa-envelope"></i> Reservar
                </button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="@modalMailId" tabindex="-1" aria-labelledby="@($"title-{modalMailId}")" aria-hidden="true">
    <div class="modal-dialog modal-md modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="@($"title-{modalMailId}")">Formulario de Contacto</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @await Html.PartialAsync("_FormularioConsultaMail", Model)
            </div>
        </div>
    </div>
</div>