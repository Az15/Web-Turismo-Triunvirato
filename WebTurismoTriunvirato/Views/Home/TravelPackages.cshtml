@model IEnumerable<Web_Turismo_Triunvirato.Models.PackagePromotion>
@using System.Globalization;
@using Web_Turismo_Triunvirato.Models.ViewModels

@{
    ViewData["Title"] = "¡Promociones!";
}
<link rel="stylesheet" href="~/css/vuelos.css" />

<div class="flight-search-container">
    <h2>¡Encuentra tu Promocion ideal!</h2>

    <div class="flight-search-options">
        <label>
            <input type="radio" name="flight-type" value="round-trip" checked> Ida y Vuelta
        </label>
        <label>
            <input type="radio" name="flight-type" value="one-way"> Solo Ida
        </label>
        <label>
            <input type="radio" name="flight-type" value="multi-destination"> Multidestino
        </label>
    </div>

    <div class="flight-search-inputs">
        <div class="input-group">
            <label for="origin">Origen</label>
            <input type="text" id="origin" placeholder="Ingresa ciudad, país o región">
        </div>

        <button class="search-button">Buscar</button>
    </div>
</div>

<section class="destinations-section">
    <h2>¡Promociones más buscadas!</h2>

    <div class="destinations-grid">
        @if (Model != null && Model.Any())
        {
            foreach (var promotion in Model)
            {
                string tipoViaje = promotion.PackageType switch
                {
                    "BusYHotel" => "Traslado",
                    "VueloYHotel" => "Vuelo",
                    _ => promotion.PackageType
                };

                // --- FILTRO PARA EVITAR DUPLICADOS EN LA GALERÍA ---
                // Solo incluimos las imágenes adicionales si su URL es distinta a la de portada
                var galeriaFiltrada = promotion.ImagenesAdicionales?
                .Where(img => img.Url != promotion.ImageUrl)
                .ToList();

                var modalVM = new ModalContratoViewModel
                    {
                        IdItem = promotion.Id,
                        Title = $"Paquete a {promotion.DestinationName} ({promotion.PackageType})",
                        ImageUrl = Url.Content(promotion.ImageUrl),
                        Price = promotion.OfferPrice,

                        // Usamos la galería filtrada aquí
                        GaleriaImagenes = galeriaFiltrada,

                        LongDescription =
                    $"{promotion.OriginName} ⮂ {promotion.DestinationName}.<br><br><br>" +
                    $"Promoción válida hasta el <span class='promo-fecha'>{promotion.EndDate:dd/MM/yyyy}</span>.",

                        PackageDetailsSerialized = $"PAQUETE: {promotion.DestinationName} | TIPO: {tipoViaje} + Hotel | ORIGEN: {promotion.OriginName} | PRECIO: {promotion.OfferPrice:C} | VALIDEZ: {promotion.EndDate:dd/MM/yyyy}",

                        LongDescription2 = promotion.Description,

                        DetailText = $"{tipoViaje} + Hospedaje",

                        RenderedWhatsappMessage = promotion.RenderedWhatsappMessage,
                    };

                var modalTargetId = $"packageModal-{modalVM.IdItem}";

                <div class="destination-card">
                    @* BADGES *@
                    @if (promotion.IsHotWeek)
                    {
                        <span class="hot-week-badge">HOT WEEK</span>
                    }
                    else if (promotion.DiscountPercentage > 0)
                    {
                        <span class="discount-badge">
                            ¡@promotion.DiscountPercentage.ToString("F0")% OFF!
                        </span>
                    }

                    <div class="image-container">
                        <img src="@Url.Content(promotion.ImageUrl)"
                             alt="@promotion.DestinationName">
                    </div>

                    <div class="destination-info">
                        <h3 class="mb-1">@promotion.DestinationName</h3>

                        <p class="price">
                            @promotion.OfferPrice.ToString("C0",
                                     new CultureInfo("es-AR"))
                        </p>

                        <p class="details-text">
                            @modalVM.DetailText
                        </p>

                        <button type="button"
                                class="ver-detalles-button"
                                data-bs-toggle="modal"
                                data-bs-target="#@modalTargetId">
                            Ver Detalles
                        </button>
                    </div>
                </div>

                @await Html.PartialAsync("_MasInformacionGenerico", modalVM)
            }
        }
        else
        {
            <p class="col-12 alert alert-info text-center">
                No hay destinos populares de ¡Promociones! disponibles en este momento.
            </p>
        }
    </div>
</section>

<script>
    function cambiarImagenModal(idItem, urlNueva) {
        const modalElement = document.getElementById('packageModal-' + idItem);
        if (modalElement) {
            const imgPrincipal = modalElement.querySelector('.img-principal-modal');
            if (imgPrincipal) {
                imgPrincipal.style.opacity = '0.5';
                setTimeout(() => {
                    imgPrincipal.src = urlNueva;
                    imgPrincipal.style.opacity = '1';
                }, 150);
            }
        }
    }
</script>